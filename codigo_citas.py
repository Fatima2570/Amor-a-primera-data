# -*- coding: utf-8 -*-
"""codigo_citas

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1UcvVKqphG_csJ7ktFoZMXD7ONxvX0zAn
"""

import streamlit as st
import pandas as pd
import gspread
import json
from oauth2client.service_account import ServiceAccountCredentials

st.set_page_config(page_title="ğŸ’– Amor A Primera Data ğŸ’–")

st.title("ğŸ’– Amor A Primera Data ğŸ’–")
st.caption("Encuentra el match perfecto basado en tus gustos, valores y estilo de vida.")

# AutenticaciÃ³n con Google Sheets desde secrets
scope = ["https://www.googleapis.com/auth/spreadsheets"]
creds_dict = json.loads(st.secrets["GOOGLE_SHEETS_CREDENTIALS"])
creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_dict, scope)
client = gspread.authorize(creds)
sheet = client.open("APP DE CITAS").sheet1

# Leer datos desde la hoja
try:
    data = sheet.get_all_records()
    db = pd.DataFrame(data)
except:
    db = pd.DataFrame(columns=[
        'Correo', 'Nombre', 'Edad', 'GÃ©nero', 'GÃ©nero_Buscado', 'Signo',
        'Instagram', 'RelaciÃ³n', 'Hobbies', 'Hijos', 'Altura',
        'Altura_Buscada', 'ReligiÃ³n', 'Universidad', 'Carrera', 'Rango_Edad'
    ])

# Formulario
st.subheader("ğŸ“‹ Completa tu perfil")

with st.form("form_usuario"):
    correo = st.text_input("Correo electrÃ³nico (usado para evitar duplicados)", placeholder="ejemplo@gmail.com")
    nombre = st.text_input("Nombre")
    edad = st.slider("Edad", 18, 60)

    genero = st.selectbox("Â¿Con quÃ© gÃ©nero te identificas?", ["Hombre", "Mujer", "Otro"])
    genero_buscado = st.multiselect("Â¿QuÃ© gÃ©nero(s) buscas?", ["Hombre", "Mujer", "Ambos"])

    signo = st.selectbox("Signo zodiacal", [
        "Aries", "Tauro", "GÃ©minis", "CÃ¡ncer", "Leo", "Virgo",
        "Libra", "Escorpio", "Sagitario", "Capricornio", "Acuario", "Piscis"
    ])

    instagram = st.text_input("Tu Instagram (opcional)")
    relacion = st.radio("Â¿QuÃ© tipo de relaciÃ³n buscas?", ["Seria", "Casual"])

    hobbies = st.multiselect("Selecciona tus hobbies", [
        "Leer", "Bailar", "Cocinar", "Viajar", "Jugar videojuegos", "Hacer deporte",
        "Ver pelÃ­culas", "Escuchar mÃºsica", "Escribir", "Arte", "Naturaleza"
    ])

    hijos = st.radio("Â¿Quieres tener hijos?", ["SÃ­", "No"])
    altura = st.number_input("Â¿CuÃ¡l es tu altura? (en cm)", min_value=100, max_value=250)
    altura_buscada = st.selectbox("Â¿QuÃ© altura prefieres en tu pareja?", [
        "Misma altura", "MÃ¡s alto", "MÃ¡s bajo"
    ])

    religion = st.selectbox("Â¿CuÃ¡l es tu religiÃ³n?", ["Creyente", "Ateo", "AgnÃ³stico"])
    universidad = st.text_input("Â¿En quÃ© universidad o instituto estudias?")
    carrera = st.text_input("Â¿QuÃ© carrera estudias?")

    rango_edad = st.selectbox("Â¿QuÃ© rango de edad aceptarÃ­as para tu pareja?", [
        "Misma edad", "Hasta 5 aÃ±os mÃ¡s", "Hasta 5 aÃ±os menos"
    ])

    submit = st.form_submit_button("Buscar pareja ğŸ’–")

# Compatibilidad zodiacal bÃ¡sica
compat_zodiaco = {
    "Aries": ["Leo", "Sagitario", "GÃ©minis"],
    "Tauro": ["Virgo", "Capricornio", "CÃ¡ncer"],
    "GÃ©minis": ["Libra", "Acuario", "Aries"],
    "CÃ¡ncer": ["Escorpio", "Piscis", "Tauro"],
    "Leo": ["Aries", "Sagitario", "Libra"],
    "Virgo": ["Tauro", "Capricornio", "Escorpio"],
    "Libra": ["GÃ©minis", "Acuario", "Leo"],
    "Escorpio": ["CÃ¡ncer", "Piscis", "Virgo"],
    "Sagitario": ["Aries", "Leo", "Acuario"],
    "Capricornio": ["Tauro", "Virgo", "Piscis"],
    "Acuario": ["GÃ©minis", "Libra", "Sagitario"],
    "Piscis": ["CÃ¡ncer", "Escorpio", "Capricornio"]
}

def calcular_compatibilidad(persona):
    puntos = 0
    if genero in persona["GÃ©nero_Buscado"].split(";") and persona["GÃ©nero"] in genero_buscado:
        puntos += 1
    if persona["RelaciÃ³n"] == relacion:
        puntos += 1
    if persona["Hijos"] == hijos:
        puntos += 1
    if religion == persona["ReligiÃ³n"]:
        puntos += 1
    if signo in compat_zodiaco.get(persona["Signo"], []):
        puntos += 1
    if altura_buscada == "Misma altura" and abs(altura - persona["Altura"]) <= 5:
        puntos += 1
    elif altura_buscada == "MÃ¡s alto" and persona["Altura"] > altura:
        puntos += 1
    elif altura_buscada == "MÃ¡s bajo" and persona["Altura"] < altura:
        puntos += 1
    hobbies_en_comun = set(hobbies).intersection(set(persona["Hobbies"].split(";")))
    puntos += len(hobbies_en_comun)
    edad_dif = int(persona["Edad"]) - edad
    if rango_edad == "Misma edad" and abs(edad_dif) == 0:
        puntos += 1
    elif rango_edad == "Hasta 5 aÃ±os mÃ¡s" and 0 < edad_dif <= 5:
        puntos += 1
    elif rango_edad == "Hasta 5 aÃ±os menos" and -5 <= edad_dif < 0:
        puntos += 1
    return puntos

if submit:
    if correo in db["Correo"].values:
        st.warning("âš ï¸ Ya hay una cuenta registrada con este correo. No puedes enviar otra vez el formulario.")
    else:
        nuevo_usuario = {
            "Correo": correo,
            "Nombre": nombre,
            "Edad": edad,
            "GÃ©nero": genero,
            "GÃ©nero_Buscado": ";".join(genero_buscado),
            "Signo": signo,
            "Instagram": instagram,
            "RelaciÃ³n": relacion,
            "Hobbies": ";".join(hobbies),
            "Hijos": hijos,
            "Altura": altura,
            "Altura_Buscada": altura_buscada,
            "ReligiÃ³n": religion,
            "Universidad": universidad,
            "Carrera": carrera,
            "Rango_Edad": rango_edad
        }

        # Agregar a Google Sheets
        sheet.append_row(list(nuevo_usuario.values()))

        st.success("âœ… Â¡Tu informaciÃ³n ha sido registrada correctamente!")

        # Buscar matches compatibles (excluyendo a sÃ­ mismo)
        posibles_matches = db[db["Correo"] != correo].copy()

        if not posibles_matches.empty:
            posibles_matches["compatibilidad"] = posibles_matches.apply(calcular_compatibilidad, axis=1)
            mejores = posibles_matches[posibles_matches["compatibilidad"] >= 4]
            mejores = mejores.sort_values("compatibilidad", ascending=False)

            if not mejores.empty:
                st.markdown("### ğŸ’ Â¡Hemos encontrado personas compatibles!")
                for i, match in mejores.iterrows():
                    st.markdown(f"**ğŸ‘¤ Nombre:** {match['Nombre']}  \n"
                                f"ğŸ“ Universidad: {match['Universidad']}  \n"
                                f"ğŸ“™ Carrera: {match['Carrera']}  \n"
                                f"ğŸ“² Instagram: {match['Instagram']}  \n"
                                f"ğŸŒŸ Compatibilidad: {match['compatibilidad']} puntos")
            else:
                st.info("TodavÃ­a no hay personas que hagan match contigo. Â¡Vuelve mÃ¡s tarde a consultar!")
        else:
            st.info("Eres la primera persona en registrarte. Vuelve en un momento para revisar tus matches ğŸ˜Š")